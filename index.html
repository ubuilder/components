<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <link rel="stylesheet" href="./src/styles.css">
</head>

<div u-accordions u-bind='{"id": 0}'>
    <div u-accordion>
        <div u-accordion-header u-bind-dblclick="id = 1" u-bind-attr="u-accordion-header-open = id == 1">
            <div u-accordion-title>Header</div>
        </div>
        <div u-accordion-content u-bind-attr="u-accordion-content-open = id == 1">
            <div u-accordion-body>Body</div>
        </div>
    </div>
    <div u-accordion>
        <div u-accordion-header u-bind-click="id = 2" u-bind-attr="u-accordion-header-open = id == 2">
            <div u-accordion-title>Header 2</div>
        </div>
        <div u-accordion-content u-bind-attr="u-accordion-content-open = id == 2">
            <div u-accordion-body>Body 2</div>
        </div>
    </div>

</div>


<!-- <div u-bind='{"id": 1}'>
    <div>
        <div u-bind-click="id = 1">Item 1</div>
        <div u-bind-click="id = 2">Item 2</div>
        <div u-bind-click="id = 3">Item 3</div>
    </div>
    <div>
        <div u-bind-show="id == 1">
            Content 1
        </div>
        <div u-bind-show="id == 2">
            Content 2
        </div>
        <div u-bind-show="id == 3">
            Content 3
        </div>
    </div>
</div> -->

<body>

    <script>
        function condition(val, sections) {
            if (sections.length === 1) {
                return val;
            } else if (sections.length === 3) {
                const [key, operator, value] = sections
                if (operator === '==') {
                    return val == value

                } else if (operator === '!=') {
                    return val != value
                }
            }
            return false;
        }

        function writable(value) {
            let cbs = []
            let _value = value;
            return {
                subscribe(cb) {
                    cb(_value)

                    cbs.push(cb)
                    return () => {
                        cbs = cbs.filter(x => x !== cb)
                    }
                },
                set(val) {
                    _value = val
                    cbs.forEach(cb => cb(_value))
                },
                update(setter) {
                    _value = setter(_value)
                    cbs.forEach(cb => cb(_value))
                }
            }
        }

        function Bind($el) {
            const bind = $el.getAttribute('u-bind')
            $el.removeAttribute('u-bind')

            const ctx = {}


            if (bind) {
                const props = JSON.parse(bind)

                for (let key in props) {
                    ctx[key] = writable(props[key])
                }

                $el.querySelectorAll("*").forEach((el) => {


                    // ----------------------------------
                    if (el.hasAttribute('u-bind-value')) {
                        const key = el.getAttribute('u-bind-value')
                        el.removeAttribute('u-bind-value')
                        if (!ctx[key]) return;

                        const { subscribe, set } = ctx[key]

                        subscribe(val => el.value = val)

                        el.addEventListener('input', ev => {
                            set(ev.target.value)
                        })
                    }

                    // ----------------------------------
                    if (el.hasAttribute('u-bind-attr')) {
                        const code = el.getAttribute('u-bind-attr')
                        el.removeAttribute('u-bind-attr')

                        const [key, _eq, ...value] = code.split(' ')

                        if (!ctx[value[0]]) return;

                        const { subscribe, set } = ctx[value[0]]

                        subscribe(val => {

                            const cond = condition(val, value)

                            if (value.length === 1) {
                                el.setAttribute(key, value)
                            } else {
                                if (cond) {
                                    el.setAttribute(key, '')
                                } else {
                                    el.removeAttribute(key)
                                }
                            }

                        })
                    }

                    // ----------------------------------
                    if (el.hasAttribute('u-bind-show')) {
                        const code = el.getAttribute('u-bind-show')
                        el.removeAttribute('u-bind-show')

                        const sections = code.split(' ');
                        const key = sections[0]

                        if (!ctx[key]) return;
                        const { subscribe, set } = ctx[key]

                        subscribe(val => {

                            el.style.display = condition(val, sections) ? '' : 'none'
                        })
                    }

                    // ----------------------------------
                    if (el.hasAttribute('u-bind-text')) {
                        const key = el.getAttribute('u-bind-text')
                        el.removeAttribute('u-bind-text')

                        if (!ctx[key]) return;

                        const { subscribe, set } = ctx[key]

                        if (el.textContent) {
                            set(el.textContent)
                        }


                        subscribe(val => el.textContent = val)

                    }
                    // ----------------------------------
                    if (el.hasAttribute('u-bind-html')) {

                        const key = el.getAttribute('u-bind-html')
                        el.removeAttribute('u-bind-html')

                        if (!ctx[key]) return;


                        const { subscribe, set } = ctx[key]

                        subscribe(val => el.innerHTML = val)
                    }

                    // ----------------------------------
                    Array.from(el.attributes).forEach(attribute => {
                        if (attribute.name.startsWith('u-bind-')) {
                            const event = attribute.name.substring('u-bind-'.length);
                            el.removeAttribute('u-bind-' + event)

                            const code = attribute.value;
                            el.addEventListener(event, () => {

                                const [key, operator, ...value] = code.split(' ').map(str => str.trim())

                                if (!ctx[key]) return;


                                if (value.length === 1) {
                                    if (operator === '=') {
                                        if (!isNaN(value[0])) value[0] = +value[0]

                                        ctx[key].set(value[0])
                                    } else if (operator === '!=') {
                                        if (value[0] === key) {
                                            ctx[key].update(val => !val)
                                        }
                                    } else if (operator === '+=') {
                                        ctx[key].update(val => +val + +value[0])
                                    } else if (operator === '-=') {
                                        ctx[key].update(val => +val - +value[0])
                                    }

                                }

                            })

                        }

                    })
                });
            }
        }

        document.querySelectorAll('[u-bind]').forEach(el => Bind(el))
    </script>
</body>

</html>